# Benchmarks

Since okra is built on top of LMDB and exposes the same external key/value store interface, we can compare okra's performance to using LMDB directly.

In these benchmarks, entries are generated by taking the Blake3 hash of monotonically incrementing u32 big-endian integers, and using the first 16 bytes as the key and the last 16 bytes as the value.

The numbers here were produced on a 2021 M1 MacBook Pro with 32GB RAM running macos 13.1 with a 1TB SSD.

> The very rough takeaway here is that, when compared to baseline LMDB performance, okra can do about 1/2 the ops/s for reads, and between 2/3 to 1/10 the ops/s for writes, depending mostly on the size of the database and the way that transactions are batched.

## LMDB benchmarks

Run the LMDB benchmarks:

```sh
$ zig build bench-lmdb
```

### Initial DB size: 1,000 entries

|                                | iterations | min (ns) | max (ns) | avg (ns) |      std |    ops / s |
| :----------------------------- | ---------: | -------: | -------: | -------: | -------: | ---------: |
| read 1 random entry            |        100 |      500 |    12375 |     1076 |     1346 |     929368 |
| iterate over all entries       |        100 |    10791 |    26000 |    11029 |     1506 |   90670051 |
| set 1 random entry             |        100 |    61250 |   182333 |    83184 |    20578 |      12021 |
| set 1,000 random entries       |        100 |   454792 |   599458 |   485251 |    23193 |    2060789 |
| set 50,000 random entries      |         10 | 22049083 | 23150333 | 22251454 |   307460 |    2247044 |

### Initial DB size: 50,000 entries

|                                | iterations | min (ns) | max (ns) | avg (ns) |      std |    ops / s |
| :----------------------------- | ---------: | -------: | -------: | -------: | -------: | ---------: |
| read 1 random entry            |        100 |      333 |     7000 |     1153 |      691 |     867302 |
| iterate over all entries       |        100 |   250958 |   399875 |   258690 |    17911 |  193281533 |
| set 1 random entry             |        100 |    74625 |   168583 |   121551 |    19080 |       8226 |
| set 1,000 random entries       |        100 |  1653083 |  4549917 |  1815132 |   342399 |     550924 |
| set 50,000 random entries      |         10 | 24989584 | 28260625 | 25718412 |  1066868 |    1944132 |

### Initial DB size: 1,000,000 entries

|                                | iterations | min (ns) | max (ns) | avg (ns) |      std |    ops / s |
| :----------------------------- | ---------: | -------: | -------: | -------: | -------: | ---------: |
| read 1 random entry            |        100 |      583 |    10250 |     1339 |      971 |     746825 |
| iterate over all entries       |        100 |  6499542 |  7317500 |  6557768 |    90276 |  152490908 |
| set 1 random entry             |        100 |   290250 |   380708 |   305970 |    15935 |       3268 |
| set 1,000 random entries       |        100 |  6444834 | 15972625 |  7859663 |  2256396 |     127231 |
| set 50,000 random entries      |         10 | 69228875 | 86158917 | 76322462 |  5492760 |     655115 |

## okra benchmarks

Run the okra benchmarks:

```sh
$ zig build bench
```

### Initial DB size: 1,000 entries

|                                | iterations |   min (ns) |   max (ns) |   avg (ns) |        std |    ops / s |
| :----------------------------- | ---------: | ---------: | ---------: | ---------: | ---------: | ---------: |
| read 1 random entry            |        100 |       1333 |      16458 |       2124 |       1680 |     470809 |
| iterate over all entries       |        100 |      15000 |      96708 |      18890 |      10718 |   52938062 |
| set 1 random entry             |        100 |      75459 |     173334 |      95349 |      17728 |      10487 |
| set 1,000 random entries       |        100 |    5517958 |    5940708 |    5558630 |      49607 |     179900 |
| set 50,000 random entries      |         10 |  383082375 |  384628292 |  383655679 |     455967 |     130325 |

### Initial DB size: 50,000 entries

|                                | iterations |   min (ns) |   max (ns) |   avg (ns) |        std |    ops / s |
| :----------------------------- | ---------: | ---------: | ---------: | ---------: | ---------: | ---------: |
| read 1 random entry            |        100 |        667 |      28000 |       1694 |       2712 |     590318 |
| iterate over all entries       |        100 |     732375 |    1027167 |     738720 |      29551 |   67684643 |
| set 1 random entry             |        100 |      97208 |     185750 |     141838 |      24784 |       7050 |
| set 1,000 random entries       |        100 |   10799375 |   13531167 |   11077129 |     443500 |      90276 |
| set 50,000 random entries      |         10 |  454495708 |  460459333 |  455854091 |    1776659 |     109684 |

### Initial DB size: 1,000,000 entries

|                                | iterations |   min (ns) |   max (ns) |   avg (ns) |        std |    ops / s |
| :----------------------------- | ---------: | ---------: | ---------: | ---------: | ---------: | ---------: |
| read 1 random entry            |        100 |        916 |       8084 |       1722 |        970 |     580720 |
| iterate over all entries       |        100 |   17888666 |   18444500 |   17988865 |      91735 |   55589944 |
| set 1 random entry             |        100 |     445833 |     717083 |     472434 |      30761 |       2116 |
| set 1,000 random entries       |        100 |   20147000 |   28155125 |   21471819 |    1739645 |      46572 |
| set 50,000 random entries      |         10 |  671717458 |  719311042 |  684146012 |   13422370 |      73083 |

One observation here is that batching many writes in one transaction is not as relatively efficient with okra as it is in LMDB itself: for databases with 1 million entries, setting 50k new entries in one transaction is ~200x faster than setting one entry in 50k transactions when using LMDB directly, but only ~34x faster when using okra. In other words, the effectiveness of batching writes diminishes faster.
